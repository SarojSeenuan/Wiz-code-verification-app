# S05: シークレット検出 - ハードコードされた認証情報検出ワークフロー
#
# このワークフローは、ソースコード、IaC、設定ファイル内のシークレット検出を実施します
# シナリオS05の検証に使用します

name: S05 - Wiz Secret Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  secret-scan-source-code:
    name: ソースコードシークレットスキャン
    runs-on: ubuntu-latest
    steps:
      - name: コードチェックアウト
        uses: actions/checkout@v4

      - name: Wiz CLIダウンロード
        run: |
          curl -o wizcli https://downloads.wiz.io/wizcli/latest/wizcli-linux-amd64
          chmod +x wizcli
          sudo mv wizcli /usr/local/bin/

      - name: Wiz認証
        run: |
          wizcli auth --id "${{ secrets.WIZ_CLIENT_ID }}" --secret "${{ secrets.WIZ_CLIENT_SECRET }}"

      - name: バックエンドシークレットスキャン
        run: |
          wizcli dir scan \
            --path ./backend \
            --secret-scan-only \
            --name "backend-secrets-${{ github.sha }}" \
            --tag "component=backend" \
            --tag "scan-type=secret-detection"

      - name: フロントエンドシークレットスキャン
        run: |
          wizcli dir scan \
            --path ./frontend \
            --secret-scan-only \
            --name "frontend-secrets-${{ github.sha }}" \
            --tag "component=frontend" \
            --tag "scan-type=secret-detection"

  secret-scan-iac:
    name: IaCシークレットスキャン
    runs-on: ubuntu-latest
    steps:
      - name: コードチェックアウト
        uses: actions/checkout@v4

      - name: Wiz CLIダウンロード
        run: |
          curl -o wizcli https://downloads.wiz.io/wizcli/latest/wizcli-linux-amd64
          chmod +x wizcli
          sudo mv wizcli /usr/local/bin/

      - name: Wiz認証
        run: |
          wizcli auth --id "${{ secrets.WIZ_CLIENT_ID }}" --secret "${{ secrets.WIZ_CLIENT_SECRET }}"

      - name: Terraformシークレットスキャン
        run: |
          wizcli dir scan \
            --path ./terraform \
            --secret-scan-only \
            --name "terraform-secrets-${{ github.sha }}" \
            --tag "component=terraform" \
            --tag "scan-type=secret-detection"

  secret-scan-k8s:
    name: K8sマニフェストシークレットスキャン
    runs-on: ubuntu-latest
    steps:
      - name: コードチェックアウト
        uses: actions/checkout@v4

      - name: Wiz CLIダウンロード
        run: |
          curl -o wizcli https://downloads.wiz.io/wizcli/latest/wizcli-linux-amd64
          chmod +x wizcli
          sudo mv wizcli /usr/local/bin/

      - name: Wiz認証
        run: |
          wizcli auth --id "${{ secrets.WIZ_CLIENT_ID }}" --secret "${{ secrets.WIZ_CLIENT_SECRET }}"

      - name: K8sシークレットスキャン
        run: |
          wizcli dir scan \
            --path ./k8s \
            --secret-scan-only \
            --name "k8s-secrets-${{ github.sha }}" \
            --tag "component=kubernetes" \
            --tag "scan-type=secret-detection"

  secret-scan-scripts:
    name: スクリプトシークレットスキャン
    runs-on: ubuntu-latest
    steps:
      - name: コードチェックアウト
        uses: actions/checkout@v4

      - name: Wiz CLIダウンロード
        run: |
          curl -o wizcli https://downloads.wiz.io/wizcli/latest/wizcli-linux-amd64
          chmod +x wizcli
          sudo mv wizcli /usr/local/bin/

      - name: Wiz認証
        run: |
          wizcli auth --id "${{ secrets.WIZ_CLIENT_ID }}" --secret "${{ secrets.WIZ_CLIENT_SECRET }}"

      - name: スクリプトシークレットスキャン
        run: |
          wizcli dir scan \
            --path ./scripts \
            --secret-scan-only \
            --name "scripts-secrets-${{ github.sha }}" \
            --tag "component=scripts" \
            --tag "scan-type=secret-detection"

  generate-secret-report:
    name: シークレット検出レポート生成
    runs-on: ubuntu-latest
    needs: [secret-scan-source-code, secret-scan-iac, secret-scan-k8s, secret-scan-scripts]
    if: always()
    steps:
      - name: シークレットスキャンサマリー出力
        run: |
          echo "## S05検証: シークレット検出結果" > secret-scan-summary.md
          echo "" >> secret-scan-summary.md
          echo "- ブランチ: ${{ github.ref_name }}" >> secret-scan-summary.md
          echo "- コミット: ${{ github.sha }}" >> secret-scan-summary.md
          echo "" >> secret-scan-summary.md
          echo "### スキャン対象" >> secret-scan-summary.md
          echo "- backend/" >> secret-scan-summary.md
          echo "- frontend/" >> secret-scan-summary.md
          echo "- terraform/" >> secret-scan-summary.md
          echo "- k8s/" >> secret-scan-summary.md
          echo "- scripts/" >> secret-scan-summary.md
          echo "" >> secret-scan-summary.md
          echo "### 検出対象シークレットタイプ" >> secret-scan-summary.md
          echo "- AWS Access Keys" >> secret-scan-summary.md
          echo "- API Keys" >> secret-scan-summary.md
          echo "- データベースパスワード" >> secret-scan-summary.md
          echo "- JWT Secrets" >> secret-scan-summary.md
          echo "- Private Keys" >> secret-scan-summary.md
          echo "" >> secret-scan-summary.md
          echo "詳細はWizコンソールで確認してください。" >> secret-scan-summary.md

      - name: レポートをアーティファクトとして保存
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-summary-${{ github.sha }}
          path: secret-scan-summary.md
