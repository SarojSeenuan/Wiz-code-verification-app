# S03: CI/CDçµ±åˆ - Wizå®Œå…¨ã‚¹ã‚­ãƒ£ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã€ä¾å­˜é–¢ä¿‚ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®å®Œå…¨ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿæ–½ã—ã¾ã™
# ã‚·ãƒŠãƒªã‚ªS03ã®æ¤œè¨¼ã«ä½¿ç”¨ã—ã¾ã™

name: S03 - Wiz Full Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '18'
  REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  IMAGE_NAME_BACKEND: taskflow-backend
  IMAGE_NAME_FRONTEND: taskflow-frontend

jobs:
  # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
  source-code-scan:
    name: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Wiz CLIãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        run: |
          curl -o wizcli https://downloads.wiz.io/wizcli/latest/wizcli-linux-amd64
          chmod +x wizcli
          sudo mv wizcli /usr/local/bin/

      - name: Wizèªè¨¼
        run: |
          wizcli auth --id "${{ secrets.WIZ_CLIENT_ID }}" --secret "${{ secrets.WIZ_CLIENT_SECRET }}"

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          wizcli dir scan \
            --path ./backend \
            --name "backend-source-${{ github.sha }}" \
            --tag "component=backend" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --tag "scan-type=source-code" \
            --policy-hits-only

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          wizcli dir scan \
            --path ./frontend \
            --name "frontend-source-${{ github.sha }}" \
            --tag "component=frontend" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --tag "scan-type=source-code" \
            --policy-hits-only

  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã¨ã‚¹ã‚­ãƒ£ãƒ³
  docker-build-and-scan:
    name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼†ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    needs: source-code-scan
    strategy:
      matrix:
        component: [backend, frontend]
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: AWSèªè¨¼æƒ…å ±è¨­å®š
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Amazon ECRãƒ­ã‚°ã‚¤ãƒ³
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
        run: |
          cd ${{ matrix.component }}
          docker build -t taskflow-${{ matrix.component }}:${{ github.sha }} .

      - name: Wiz CLIãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        run: |
          curl -o wizcli https://downloads.wiz.io/wizcli/latest/wizcli-linux-amd64
          chmod +x wizcli
          sudo mv wizcli /usr/local/bin/

      - name: Wizèªè¨¼
        run: |
          wizcli auth --id "${{ secrets.WIZ_CLIENT_ID }}" --secret "${{ secrets.WIZ_CLIENT_SECRET }}"

      - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³
        id: docker_scan
        run: |
          wizcli docker scan \
            --image taskflow-${{ matrix.component }}:${{ github.sha }} \
            --tag "component=${{ matrix.component }}" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --tag "build-number=${{ github.run_number }}" \
            --tag "scan-type=container-image" \
            --dockerfile ./${{ matrix.component }}/Dockerfile \
            --output docker-${{ matrix.component }}-results.sarif,sarif \
            --output docker-${{ matrix.component }}-results.json,json \
            --policy-hits-only
        continue-on-error: true

      - name: SARIFçµæœã‚’GitHub Securityã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: docker-${{ matrix.component }}-results.sarif
          category: wiz-docker-${{ matrix.component }}

      - name: ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’Artifactã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docker-scan-results-${{ matrix.component }}-${{ github.sha }}
          path: |
            docker-${{ matrix.component }}-results.sarif
            docker-${{ matrix.component }}-results.json

      - name: ã‚¹ã‚­ãƒ£ãƒ³çµæœã®ç¢ºèª
        if: steps.docker_scan.outcome == 'failure'
        run: |
          echo "âŒ ${{ matrix.component }}ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³ã§ãƒãƒªã‚·ãƒ¼é•åã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
          echo "ğŸ“Š æ¤œå‡ºã‚µãƒãƒªãƒ¼:"
          cat docker-${{ matrix.component }}-results.json | jq '.summary' || echo "No summary available"
          echo ""
          echo "è©³ç´°ã¯GitHub Securityã‚¿ãƒ–ã¨Wizã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„"

      - name: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ä»˜ã‘ã¨ECRãƒ—ãƒƒã‚·ãƒ¥ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
        if: github.ref == 'refs/heads/main'
        run: |
          docker tag taskflow-${{ matrix.component }}:${{ github.sha }} \
            ${{ env.REGISTRY }}/taskflow-${{ matrix.component }}:${{ github.sha }}
          docker tag taskflow-${{ matrix.component }}:${{ github.sha }} \
            ${{ env.REGISTRY }}/taskflow-${{ matrix.component }}:latest

          docker push ${{ env.REGISTRY }}/taskflow-${{ matrix.component }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/taskflow-${{ matrix.component }}:latest

  # è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  generate-report:
    name: è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [source-code-scan, docker-build-and-scan]
    if: always()
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Wiz CLIãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        run: |
          curl -o wizcli https://downloads.wiz.io/wizcli/latest/wizcli-linux-amd64
          chmod +x wizcli
          sudo mv wizcli /usr/local/bin/

      - name: Wizèªè¨¼
        run: |
          wizcli auth --id "${{ secrets.WIZ_CLIENT_ID }}" --secret "${{ secrets.WIZ_CLIENT_SECRET }}"

      - name: ã‚¹ã‚­ãƒ£ãƒ³ã‚µãƒãƒªãƒ¼å‡ºåŠ›
        run: |
          echo "## S03æ¤œè¨¼: Wizå®Œå…¨ã‚¹ã‚­ãƒ£ãƒ³çµæœ" > scan-summary.md
          echo "" >> scan-summary.md
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}" >> scan-summary.md
          echo "- ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}" >> scan-summary.md
          echo "- ãƒ“ãƒ«ãƒ‰ç•ªå·: ${{ github.run_number }}" >> scan-summary.md
          echo "" >> scan-summary.md
          echo "è©³ç´°ã¯Wizã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> scan-summary.md

      - name: ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: wiz-scan-summary-${{ github.sha }}
          path: scan-summary.md
