# WizCode 検証シナリオ構成図

## セキュアな開発ライフサイクルを実現

本ドキュメントは、Wiz Codeの機能を包括的に検証するためのシナリオ構成を定義します。開発段階からランタイムまで、セキュリティを一貫して管理するWiz Codeの能力を実証することを目的としています。

---

## 全体構成

検証は3つのフェーズで構成され、合計11のシナリオ（S01〜S11）を実施します。

| フェーズ | 目的 | シナリオ数 |
|---------|------|-----------|
| Phase 1 | シフトレフト機能の検証（開発段階のセキュリティ） | 5シナリオ（S01〜S05） |
| Phase 2 | Code-to-Cloud トレーサビリティの検証 | 4シナリオ（S06〜S09） |
| Phase 3 | 統合シナリオと比較検証 | 2シナリオ（S10〜S11） |

---

## Phase 1: シフトレフト機能の検証（開発段階のセキュリティ）

### 概要

開発者がコードを書く段階で、セキュリティ問題を早期発見・修正することを検証します。「シフトレフト」とは、セキュリティ対策を開発ライフサイクルの早い段階（左側）に移動させるアプローチです。

---

### S01: IDE統合

**検証目的**

開発者がIDEでコードを書いている最中に、リアルタイムでセキュリティ問題を検出できることを確認します。

**検証内容**

- VSCodeにWiz Code拡張機能をインストール
- 意図的に脆弱なコードを作成（SQLインジェクション、XSS等）
- リアルタイムで警告が表示されることを確認
- 修正提案の内容と精度を評価

**期待される結果**

- コード入力中にリアルタイムで脆弱性が検出される
- 検出された問題に対して具体的な修正提案が表示される
- 開発者がコミット前に問題を修正できる

**検証対象の脆弱性例**

- SQLインジェクション
- クロスサイトスクリプティング（XSS）
- パストラバーサル
- 安全でないデシリアライゼーション

---

### S02: VCS統合

**検証目的**

プルリクエスト（PR）作成時に自動的にセキュリティスキャンが実行され、脆弱性やシークレットが検出されることを確認します。

**検証内容**

- GitHub AppとしてWiz Codeを連携
- 脆弱性を含むコードでPRを作成
- 自動スキャン結果がPRコメントとして表示されることを確認
- マージブロック機能の動作確認

**期待される結果**

- PR作成時に自動的にスキャンが開始される
- 検出結果がPRのコメントとして可視化される
- 重大な脆弱性がある場合、マージがブロックされる
- 開発者がPR内で問題を確認・修正できる

**検証ポイント**

- スキャン完了までの時間
- 検出精度（False Positive率）
- 開発者へのフィードバックの明確さ

---

### S03: CI/CD統合

**検証目的**

CI/CDパイプライン（GitHub Actions）でWiz CLIを使用したスキャンを実行し、コード・コンテナイメージのスキャンとSBOM生成が正常に動作することを確認します。

**検証内容**

- GitHub ActionsワークフローにWiz CLIスキャンを組み込み
- ソースコードスキャン（SAST）の実行
- コンテナイメージスキャンの実行
- SBOM（Software Bill of Materials）の自動生成
- スキャン失敗時のパイプライン停止動作確認

**期待される結果**

- パイプライン内でスキャンが正常に実行される
- 脆弱性検出時にビルドが失敗する（設定に応じて）
- SBOMが生成され、Wizコンソールで確認できる
- スキャン結果がアーティファクトとして保存される

**実装するワークフロー**

```yaml
# wiz-full-scan.yml の概要
- ソースコードスキャン
- Dockerイメージビルド
- イメージスキャン
- SBOM生成
- 結果のWizへのアップロード
```

---

### S04: IaCスキャン

**検証目的**

Infrastructure as Code（Terraform、CloudFormation等）の設定ミスをデプロイ前に検出できることを確認します。

**検証内容**

- 意図的に問題のあるTerraformコードを作成
  - RDSのパブリックアクセス有効化
  - 暗号化なしのS3バケット
  - 過度に許可されたセキュリティグループ
- Wiz CLIでIaCスキャンを実行
- 検出結果の確認と評価

**期待される結果**

- 設定ミスが検出される（例：RDS公開、暗号化なし）
- 各問題の重大度が適切に分類される
- 修正のための具体的なガイダンスが提供される
- コンプライアンス基準（CIS等）との照合結果が表示される

**検証対象の設定ミス**

| カテゴリ | 例 |
|---------|-----|
| ネットワーク | パブリックアクセス、過度に開放されたポート |
| 暗号化 | 保存時・転送時の暗号化なし |
| アクセス制御 | 過剰な権限、IAMポリシーの問題 |
| ログ | 監査ログの無効化 |

---

### S05: シークレット検出

**検証目的**

ソースコードやコンテナイメージ内にハードコードされたシークレット（APIキー、パスワード等）を検出できることを確認します。

**検証内容**

- テスト用のシークレットをコードに埋め込み
  - AWSアクセスキー
  - データベースパスワード
  - APIトークン
- IDE、PR、CI/CDの各段階での検出を確認
- 検出されたシークレットの種類と精度を評価

**期待される結果**

- ハードコードされたシークレットが検出される
- シークレットの種類（AWS Key、GitHub Token等）が特定される
- 検出箇所（ファイル、行番号）が明示される
- 推奨される対処方法が提示される

**検証対象のシークレット種類**

- AWS認証情報（Access Key、Secret Key）
- データベース接続文字列
- APIキー（GitHub、Stripe、SendGrid等）
- JWTシークレット
- 秘密鍵・証明書

---

## Phase 2: Code-to-Cloud トレーサビリティの検証

### 概要

デプロイされたリソースをソースコードまで遡り、影響範囲を特定する機能を検証します。クラウド環境で検出された問題を、どのコードが原因かまで追跡できることがポイントです。

---

### S06: SBOM生成と追跡

**検証目的**

SBOM（Software Bill of Materials）を生成し、依存関係の脆弱性をソースからイメージまで追跡できることを確認します。

**検証内容**

- Node.js/Pythonプロジェクトの依存関係分析
- コンテナイメージのSBOM生成
- 既知の脆弱性を持つパッケージの検出
- ソースコード → ビルド → イメージの追跡確認

**期待される結果**

- 完全な依存関係リスト（SBOM）が生成される
- 脆弱性のあるパッケージが特定される
- 各脆弱性の影響を受けるコンポーネントが明示される
- ソースコードからイメージまでの追跡が可能

**SBOM出力形式**

- CycloneDX
- SPDX

---

### S07: コンテナトレーサビリティ

**検証目的**

クラウド環境（AWS ECS/EKS）にデプロイされたコンテナを、ソースコードまで遡って追跡できることを確認します。

**検証内容**

- TaskFlowアプリケーションをAWS ECS/EKSにデプロイ
- Wiz Cloudでデプロイされたコンテナを確認
- コンテナ → ECRイメージ → CI/CDビルド → ソースコードの追跡
- Wiz Security Graphでの可視化確認

**期待される結果**

- デプロイされたコンテナがWiz Cloudで検出される
- コンテナからソースコードまでの完全な追跡が可能
- CI/CDパイプライン（GitHub Actions）との紐付けが確認できる
- 脆弱性がどのコード変更で導入されたか特定できる

**追跡パス**

```
AWS ECS/EKS
    ↓
Amazon ECR（コンテナイメージ）
    ↓
GitHub Actions（ビルドパイプライン）
    ↓
GitHub Repository（ソースコード）
```

---

### S08: ランタイム脆弱性の優先順位付け

**検証目的**

実行中のワークロードに存在する脆弱性を優先順位付けし、実際に影響のある脆弱性に集中できることを確認します。

**検証内容**

- 複数の脆弱性を含むアプリケーションをデプロイ
- Wiz Cloudでランタイム脆弱性を確認
- 「実行中」vs「未使用」パッケージの区別を確認
- 優先順位付けロジックの評価

**期待される結果**

- 実行中のパッケージに存在する脆弱性が優先表示される
- 未使用パッケージの脆弱性は低優先度として扱われる
- 脆弱性からソースコードへの紐付けが確認できる
- 実際に対処すべき脆弱性の数が削減される

**優先順位付けの要素**

| 要素 | 説明 |
|------|------|
| 実行状態 | パッケージが実際に実行されているか |
| 露出度 | インターネットからアクセス可能か |
| 権限 | 機密データへのアクセス権があるか |
| 悪用可能性 | 既知のエクスプロイトが存在するか |

---

### S09: IaC Drift検出とコード追跡

**検証目的**

クラウド環境で行われた手動変更（Drift）を検出し、IaCコードとの差分を明確にできることを確認します。

**検証内容**

- Terraformでインフラをデプロイ
- AWSコンソールから手動で設定変更を実施
  - セキュリティグループのルール追加
  - S3バケットポリシーの変更
- Wiz CloudでDriftを検出
- Terraformコードとの差分を確認

**期待される結果**

- 手動変更（Drift）が検出される
- 変更内容が具体的に表示される
- 対応するTerraformコードが特定される
- 推奨される修正方法が提示される

**Drift検出対象**

- セキュリティグループの変更
- IAMポリシーの変更
- S3バケット設定の変更
- RDS設定の変更

---

## Phase 3: 統合シナリオと比較検証（実践的な運用シナリオ）

### 概要

実際のインシデント対応や他ツールとの比較を通じて、Wiz Codeの総合力を検証します。

---

### S10: インシデント対応フロー

**検証目的**

重大な脆弱性（Log4j等）が発生した際の迅速な対応フローを実証します。影響特定からコード修正、デプロイまでの一連の流れを検証します。

**検証内容**

- Log4j脆弱性を想定したシナリオ
- Wiz Threat Centerでの脆弱性確認
- 影響を受けるリソースの特定
- ソースコードの特定と修正
- 修正版のデプロイと確認

**期待される結果**

- 脆弱性の影響範囲が即座に特定される
- 影響を受けるすべてのリソースがリストアップされる
- 対応するソースコードが特定される
- 修正後、脆弱性が解消されたことが確認できる

**対応フロー**

```
1. 脆弱性の認知（Threat Center）
    ↓
2. 影響範囲の特定（Security Graph）
    ↓
3. ソースコードの特定（Code-to-Cloud追跡）
    ↓
4. コード修正（依存関係の更新）
    ↓
5. CI/CDでビルド・スキャン
    ↓
6. デプロイ
    ↓
7. 修正確認（Wiz Cloudで再スキャン）
```

**想定所要時間**

| ステップ | 従来の方法 | Wiz使用時 |
|---------|-----------|----------|
| 影響特定 | 数時間〜数日 | 数分 |
| コード特定 | 数時間 | 即座 |
| 修正確認 | 数時間 | 数分 |

---

### S11: AWS Inspector vs Wiz比較

**検証目的**

同一のAWS ECS環境でAWS InspectorとWiz Codeを並行実行し、脆弱性検出能力とSBOM生成能力を比較します。

**検証内容**

- 同一のECS環境でAWS InspectorとWizを有効化
- 脆弱性スキャン結果の比較
  - 検出数
  - 検出精度（False Positive率）
  - 検出の詳細度
- SBOM生成能力の比較
- Code-to-Cloud追跡能力の比較

**期待される結果**

- 両ツールの検出結果を定量的に比較できる
- Wizの優位点が明確になる
  - より詳細なコンテキスト情報
  - ソースコードへの追跡能力
  - 優先順位付け機能
- TISがWizを推奨する根拠データが得られる

**比較項目**

| 項目 | AWS Inspector | Wiz |
|------|---------------|-----|
| 脆弱性検出数 | 検証で計測 | 検証で計測 |
| 検出精度 | 検証で計測 | 検証で計測 |
| SBOM生成 | サポート | サポート |
| Code-to-Cloud追跡 | なし | あり |
| 優先順位付け | 限定的 | 包括的 |
| マルチクラウド | なし | あり |

---

## 検証環境構成

### TaskFlowアプリケーション

検証用に構築するサンプルアプリケーションです。

**構成要素**

| コンポーネント | 技術スタック |
|---------------|-------------|
| フロントエンド | Next.js, React, Tailwind CSS |
| バックエンド | Node.js, Express.js, TypeScript |
| データベース | PostgreSQL (Amazon RDS) |
| コンテナレジストリ | Amazon ECR |
| コンテナオーケストレーション | Amazon ECS / EKS |
| CI/CD | GitHub Actions |
| IaC | Terraform |

### クラウド環境

- AWS（プライマリ）
- Wiz Cloud連携済み
- Wiz Code連携済み

---

## 成功基準

### Phase 1（シフトレフト）

- すべてのシナリオ（S01〜S05）で脆弱性が検出される
- 開発者フィードバックが適切に提供される
- CI/CDパイプラインでの統合が正常に動作する

### Phase 2（Code-to-Cloud）

- デプロイされたリソースからソースコードまでの完全な追跡が可能
- ランタイム脆弱性の優先順位付けが機能する
- IaC Driftが検出される

### Phase 3（統合・比較）

- インシデント対応フローが迅速に実行できる
- AWS Inspectorとの比較で定量的なデータが取得できる

---

## 参考資料

- Wiz Code公式ドキュメント
- Wiz CLI リファレンス
- GitHub Actions連携ガイド
- Terraform IaCスキャンガイド

---

*本ドキュメントは、TIS株式会社におけるWiz Code検証プロジェクトの一環として作成されました。*
