# S06: SBOM生成と追跡 - ソフトウェア部品表の完全な生成と管理
#
# このワークフローは、ソースコードとコンテナイメージからSBOMを生成し、
# 依存関係の完全な追跡を実現します
# シナリオS06の検証に使用します

name: S06 - SBOM Generation and Tracking

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  generate-source-sbom:
    name: ソースコードSBOM生成
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [backend, frontend]
    steps:
      - name: コードチェックアウト
        uses: actions/checkout@v4

      - name: Node.jsセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: 依存関係インストール
        run: |
          cd taskflow-app/${{ matrix.component }}
          # package-lock.jsonの互換性問題を解決するため、npm installを使用
          npm install

      - name: Wiz CLIダウンロード
        run: |
          docker pull public-registry.wiz.io/wiz-app/wizcli:1

          docker tag public-registry.wiz.io/wiz-app/wizcli:1 wizcli:latest

      - name: Wiz認証
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            wizcli:latest auth

      - name: SBOM生成（CycloneDX形式）
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest dir scan \
            --path /scan/taskflow-app/${{ matrix.component }} \
            --sbom-output-file /scan/sbom-${{ matrix.component }}-cyclonedx.json \
            --sbom-format cyclonedx-json \
            --name "${{ matrix.component }}-sbom-${{ github.sha }}" \
            --tag "component=${{ matrix.component }}" \
            --tag "format=cyclonedx" \
            --tag "version=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}"

      - name: SBOM生成（SPDX形式）
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest dir scan \
            --path /scan/taskflow-app/${{ matrix.component }} \
            --sbom-output-file /scan/sbom-${{ matrix.component }}-spdx.json \
            --sbom-format spdx-json \
            --name "${{ matrix.component }}-sbom-spdx-${{ github.sha }}" \
            --tag "component=${{ matrix.component }}" \
            --tag "format=spdx"

      - name: エビデンスフォルダに結果を保存
        run: |
          mkdir -p evidence/phase2/S06
          cp sbom-${{ matrix.component }}-cyclonedx.json evidence/phase2/S06/ 2>/dev/null || echo "CycloneDX SBOMファイルが見つかりません"
          cp sbom-${{ matrix.component }}-spdx.json evidence/phase2/S06/ 2>/dev/null || echo "SPDX SBOMファイルが見つかりません"
          echo "S06検証結果（ソースSBOM）を保存しました: evidence/phase2/S06/"

      - name: SBOMアーティファクト保存
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.component }}-${{ github.sha }}
          path: |
            sbom-${{ matrix.component }}-cyclonedx.json
            sbom-${{ matrix.component }}-spdx.json
            evidence/phase2/S06/

  generate-container-sbom:
    name: コンテナイメージSBOM生成
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [backend, frontend]
    steps:
      - name: コードチェックアウト
        uses: actions/checkout@v4

      - name: AWSクレデンシャル設定
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Amazon ECRログイン
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Dockerイメージビルド
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: taskflow-${{ matrix.component }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./taskflow-app/${{ matrix.component }}

      - name: Wiz CLIダウンロード
        run: |
          docker pull public-registry.wiz.io/wiz-app/wizcli:1

          docker tag public-registry.wiz.io/wiz-app/wizcli:1 wizcli:latest

      - name: Wiz認証
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            wizcli:latest auth

      - name: コンテナイメージSBOM生成（CycloneDX）
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: taskflow-${{ matrix.component }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest docker scan \
            --image $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --sbom-output-file /scan/container-sbom-${{ matrix.component }}-cyclonedx.json \
            --sbom-format cyclonedx-json \
            --tag "component=${{ matrix.component }}" \
            --tag "image-type=container" \
            --tag "format=cyclonedx"

      - name: コンテナイメージSBOM生成（SPDX）
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: taskflow-${{ matrix.component }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest docker scan \
            --image $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --sbom-output-file /scan/container-sbom-${{ matrix.component }}-spdx.json \
            --sbom-format spdx-json \
            --tag "component=${{ matrix.component }}" \
            --tag "image-type=container" \
            --tag "format=spdx"

      - name: エビデンスフォルダに結果を保存
        run: |
          mkdir -p evidence/phase2/S06
          cp container-sbom-${{ matrix.component }}-cyclonedx.json evidence/phase2/S06/ 2>/dev/null || echo "CycloneDX コンテナSBOMファイルが見つかりません"
          cp container-sbom-${{ matrix.component }}-spdx.json evidence/phase2/S06/ 2>/dev/null || echo "SPDX コンテナSBOMファイルが見つかりません"
          echo "S06検証結果（コンテナSBOM）を保存しました: evidence/phase2/S06/"

      - name: コンテナSBOMアーティファクト保存
        uses: actions/upload-artifact@v4
        with:
          name: container-sbom-${{ matrix.component }}-${{ github.sha }}
          path: |
            container-sbom-${{ matrix.component }}-cyclonedx.json
            container-sbom-${{ matrix.component }}-spdx.json
            evidence/phase2/S06/

  sbom-analysis:
    name: SBOM分析とレポート生成
    runs-on: ubuntu-latest
    needs: [generate-source-sbom, generate-container-sbom]
    if: always()
    steps:
      - name: ソースSBOMダウンロード
        uses: actions/download-artifact@v4
        with:
          pattern: sbom-*-${{ github.sha }}
          path: sbom-source/

      - name: コンテナSBOMダウンロード
        uses: actions/download-artifact@v4
        with:
          pattern: container-sbom-*-${{ github.sha }}
          path: sbom-container/

      - name: SBOM統合分析
        run: |
          echo "## S06検証: SBOM生成と追跡結果" > sbom-analysis-report.md
          echo "" >> sbom-analysis-report.md
          echo "- ブランチ: ${{ github.ref_name }}" >> sbom-analysis-report.md
          echo "- コミット: ${{ github.sha }}" >> sbom-analysis-report.md
          echo "- 実行日時: $(date)" >> sbom-analysis-report.md
          echo "" >> sbom-analysis-report.md

          echo "### 生成されたSBOMファイル" >> sbom-analysis-report.md
          echo "" >> sbom-analysis-report.md
          echo "#### ソースコードSBOM" >> sbom-analysis-report.md
          find sbom-source -type f -name "*.json" | while read file; do
            echo "- \`$(basename $file)\`: $(wc -c < $file) bytes" >> sbom-analysis-report.md
          done
          echo "" >> sbom-analysis-report.md

          echo "#### コンテナイメージSBOM" >> sbom-analysis-report.md
          find sbom-container -type f -name "*.json" | while read file; do
            echo "- \`$(basename $file)\`: $(wc -c < $file) bytes" >> sbom-analysis-report.md
          done
          echo "" >> sbom-analysis-report.md

          echo "### SBOM形式" >> sbom-analysis-report.md
          echo "- CycloneDX 1.5" >> sbom-analysis-report.md
          echo "- SPDX 2.3" >> sbom-analysis-report.md
          echo "" >> sbom-analysis-report.md

          echo "### 追跡情報" >> sbom-analysis-report.md
          echo "- GitHubリポジトリ: ${{ github.repository }}" >> sbom-analysis-report.md
          echo "- ブランチ: ${{ github.ref_name }}" >> sbom-analysis-report.md
          echo "- コミットSHA: ${{ github.sha }}" >> sbom-analysis-report.md
          echo "- ワークフローRun ID: ${{ github.run_id }}" >> sbom-analysis-report.md
          echo "" >> sbom-analysis-report.md

          echo "詳細はWizコンソールの「SBOM」セクションで確認してください。" >> sbom-analysis-report.md

      - name: SBOM分析レポート保存
        uses: actions/upload-artifact@v4
        with:
          name: sbom-analysis-report-${{ github.sha }}
          path: sbom-analysis-report.md

  sbom-version-tracking:
    name: SBOMバージョン追跡
    runs-on: ubuntu-latest
    needs: [sbom-analysis]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: コードチェックアウト
        uses: actions/checkout@v4

      - name: Wiz CLIダウンロード
        run: |
          docker pull public-registry.wiz.io/wiz-app/wizcli:1

          docker tag public-registry.wiz.io/wiz-app/wizcli:1 wizcli:latest

      - name: Wiz認証
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            wizcli:latest auth

      - name: SBOMバージョン追跡記録
        run: |
          echo "SBOMバージョン追跡を実施します"
          echo "リポジトリ: ${{ github.repository }}"
          echo "リリースタグ: ${{ github.ref_name }}"
          echo "コミット: ${{ github.sha }}"
          echo "この情報はWiz Security Graphに記録されます"
