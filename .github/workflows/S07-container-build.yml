# S07: ã‚³ãƒ³ãƒ†ãƒŠãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ - Code-to-Cloudãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä»˜ãã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€Code-to-Cloudãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã®ãŸã‚ã®
# ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä»˜ä¸ã—ã¦ECRã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã€ECSã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™
# ã‚·ãƒŠãƒªã‚ªS07ã®æ¤œè¨¼ã«ä½¿ç”¨ã—ã¾ã™
#
# å®Ÿéš›ã®AWSç’°å¢ƒè¨­å®š:
# - ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: us-east-1
# - AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: 066338625871
# - ECRãƒªãƒã‚¸ãƒˆãƒª: dev-taskflow-backend, dev-taskflow-frontend
# - ECSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼: dev-taskflow-cluster
# - ECSã‚µãƒ¼ãƒ“ã‚¹: dev-taskflow-backend-service, dev-taskflow-frontend-service

name: S07 - Container Build and Traceability

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - "taskflow-app/backend/**"
      - "taskflow-app/frontend/**"
      - "taskflow-app/docker-compose.yml"
      - ".github/workflows/S07-container-build.yml"
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: "066338625871"
  ECR_BACKEND_REPO: dev-taskflow-backend
  ECR_FRONTEND_REPO: dev-taskflow-frontend
  ECS_CLUSTER: dev-taskflow-cluster
  ECS_BACKEND_SERVICE: dev-taskflow-backend-service
  ECS_FRONTEND_SERVICE: dev-taskflow-frontend-service

jobs:
  build-and-scan-backend:
    name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰ï¼†ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: AWSã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«è¨­å®š
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” è¨ºæ–­ - ä½¿ç”¨ä¸­ã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
        run: |
          echo "=== ç¾åœ¨èªè¨¼ã•ã‚Œã¦ã„ã‚‹IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ ==="
          aws sts get-caller-identity
          echo ""
          echo "=== ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼ ==="
          CURRENT_USER=$(aws sts get-caller-identity --query 'Arn' --output text | awk -F'/' '{print $NF}')
          echo "ãƒ¦ãƒ¼ã‚¶ãƒ¼å: $CURRENT_USER"
          aws iam list-attached-user-policies --user-name $CURRENT_USER || echo "ç®¡ç†ãƒãƒªã‚·ãƒ¼å–å¾—å¤±æ•—"
          aws iam list-user-policies --user-name $CURRENT_USER || echo "ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼å–å¾—å¤±æ•—"

      - name: Amazon ECRãƒ­ã‚°ã‚¤ãƒ³
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä»˜ãï¼‰
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd taskflow-app/backend
          docker build \
            --build-arg GIT_COMMIT=${{ github.sha }} \
            --build-arg GIT_BRANCH=${{ github.ref_name }} \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg BUILD_ID=${{ github.run_id }} \
            --build-arg GITHUB_REPOSITORY=${{ github.repository }} \
            -t $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG \
            -t $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest \
            .

      - name: Wiz CLIã‚¤ãƒ¡ãƒ¼ã‚¸å–å¾—
        run: |
          docker pull public-registry.wiz.io/wiz-app/wizcli:1
          docker tag public-registry.wiz.io/wiz-app/wizcli:1 wizcli:latest

      - name: Wizèªè¨¼
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            wizcli:latest auth

      - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³
        id: docker_scan
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest docker scan \
            --image $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG \
            --policy "Default vulnerabilities policy" \
            --policy-hits-only \
            --tag "component=backend" \
            --tag "environment=dev" \
            --tag "scan-type=pre-push" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --dockerfile /scan/taskflow-app/backend/Dockerfile \
            --output /scan/backend-scan-results.sarif,sarif \
            --output /scan/backend-scan-results.json,json
        continue-on-error: true

      - name: ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-scan-results-${{ github.sha }}
          path: |
            backend-scan-results.sarif
            backend-scan-results.json

      - name: ECRã«ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest

      - name: ã‚¤ãƒ¡ãƒ¼ã‚¸æƒ…å ±ã‚’å‡ºåŠ›
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰å®Œäº†" > build-info-backend.md
          echo "" >> build-info-backend.md
          echo "- ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}" >> build-info-backend.md
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}" >> build-info-backend.md
          echo "- ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}" >> build-info-backend.md
          echo "- ãƒ“ãƒ«ãƒ‰ID: ${{ github.run_id }}" >> build-info-backend.md
          echo "- ã‚¤ãƒ¡ãƒ¼ã‚¸: \`$ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG\`" >> build-info-backend.md
          echo "- ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆlatestï¼‰: \`$ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest\`" >> build-info-backend.md
          echo "" >> build-info-backend.md
          echo "Wizã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§Code-to-Cloudãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºèªã§ãã¾ã™ã€‚" >> build-info-backend.md

      - name: ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: build-info-backend-${{ github.sha }}
          path: build-info-backend.md

  build-and-scan-frontend:
    name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰ï¼†ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: AWSã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«è¨­å®š
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Amazon ECRãƒ­ã‚°ã‚¤ãƒ³
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä»˜ãï¼‰
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd taskflow-app/frontend
          docker build \
            --build-arg GIT_COMMIT=${{ github.sha }} \
            --build-arg GIT_BRANCH=${{ github.ref_name }} \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg BUILD_ID=${{ github.run_id }} \
            --build-arg GITHUB_REPOSITORY=${{ github.repository }} \
            -t $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG \
            -t $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest \
            .

      - name: Wiz CLIã‚¤ãƒ¡ãƒ¼ã‚¸å–å¾—
        run: |
          docker pull public-registry.wiz.io/wiz-app/wizcli:1
          docker tag public-registry.wiz.io/wiz-app/wizcli:1 wizcli:latest

      - name: Wizèªè¨¼
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            wizcli:latest auth

      - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³
        id: docker_scan
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest docker scan \
            --image $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG \
            --policy "Default vulnerabilities policy" \
            --policy-hits-only \
            --tag "component=frontend" \
            --tag "environment=dev" \
            --tag "scan-type=pre-push" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --dockerfile /scan/taskflow-app/frontend/Dockerfile \
            --output /scan/frontend-scan-results.sarif,sarif \
            --output /scan/frontend-scan-results.json,json
        continue-on-error: true

      - name: ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-scan-results-${{ github.sha }}
          path: |
            frontend-scan-results.sarif
            frontend-scan-results.json

      - name: ECRã«ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest

      - name: ã‚¤ãƒ¡ãƒ¼ã‚¸æƒ…å ±ã‚’å‡ºåŠ›
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰å®Œäº†" > build-info-frontend.md
          echo "" >> build-info-frontend.md
          echo "- ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}" >> build-info-frontend.md
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}" >> build-info-frontend.md
          echo "- ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}" >> build-info-frontend.md
          echo "- ãƒ“ãƒ«ãƒ‰ID: ${{ github.run_id }}" >> build-info-frontend.md
          echo "- ã‚¤ãƒ¡ãƒ¼ã‚¸: \`$ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG\`" >> build-info-frontend.md
          echo "- ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆlatestï¼‰: \`$ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest\`" >> build-info-frontend.md
          echo "" >> build-info-frontend.md
          echo "Wizã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§Code-to-Cloudãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºèªã§ãã¾ã™ã€‚" >> build-info-frontend.md

      - name: ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: build-info-frontend-${{ github.sha }}
          path: build-info-frontend.md

  deploy-to-ecs:
    name: ECSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [build-and-scan-backend, build-and-scan-frontend]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: AWSã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«è¨­å®š
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Amazon ECRãƒ­ã‚°ã‚¤ãƒ³
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ECSã«ãƒ‡ãƒ—ãƒ­ã‚¤
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°ã—ã¾ã™..."

          # å¼·åˆ¶çš„ã«æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œï¼ˆlatestã‚¿ã‚°ã‚’ä½¿ç”¨ï¼‰
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_BACKEND_SERVICE }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸ"
          echo "ã‚¤ãƒ¡ãƒ¼ã‚¸: $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest"

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ECSã«ãƒ‡ãƒ—ãƒ­ã‚¤
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°ã—ã¾ã™..."

          # å¼·åˆ¶çš„ã«æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œï¼ˆlatestã‚¿ã‚°ã‚’ä½¿ç”¨ï¼‰
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_FRONTEND_SERVICE }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸ"
          echo "ã‚¤ãƒ¡ãƒ¼ã‚¸: $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…æ©Ÿ
        run: |
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿã—ã¦ã„ã¾ã™..."
          echo "ã“ã‚Œã«ã¯2-3åˆ†ã‹ã‹ã‚Šã¾ã™..."

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å¾…æ©Ÿ
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_BACKEND_SERVICE }} \
            --region ${{ env.AWS_REGION }} || echo "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å¾…æ©ŸãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã¯ç¶™ç¶šä¸­ï¼‰"

          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å¾…æ©Ÿ
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_FRONTEND_SERVICE }} \
            --region ${{ env.AWS_REGION }} || echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å¾…æ©ŸãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã¯ç¶™ç¶šä¸­ï¼‰"

          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèª
        run: |
          echo "## ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèª"

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹
          echo "### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_BACKEND_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].[serviceName,runningCount,desiredCount,deployments[0].status]' \
            --output table

          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹
          echo "### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_FRONTEND_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].[serviceName,runningCount,desiredCount,deployments[0].status]' \
            --output table

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          echo "## S07æ¤œè¨¼: ã‚³ãƒ³ãƒ†ãƒŠãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" > deployment-report.md
          echo "" >> deployment-report.md
          echo "### ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±" >> deployment-report.md
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}" >> deployment-report.md
          echo "- ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}" >> deployment-report.md
          echo "- ãƒ“ãƒ«ãƒ‰ID: ${{ github.run_id }}" >> deployment-report.md
          echo "- ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚: $(date)" >> deployment-report.md
          echo "- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ${{ env.AWS_REGION }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ" >> deployment-report.md
          echo "- ECSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼: ${{ env.ECS_CLUSTER }}" >> deployment-report.md
          echo "- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹: ${{ env.ECS_BACKEND_SERVICE }}" >> deployment-report.md
          echo "- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹: ${{ env.ECS_FRONTEND_SERVICE }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### ã‚¢ã‚¯ã‚»ã‚¹URL" >> deployment-report.md
          echo "- ALB DNS: \`dev-taskflow-alb-550446343.us-east-1.elb.amazonaws.com\`" >> deployment-report.md
          echo "- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: http://dev-taskflow-alb-550446343.us-east-1.elb.amazonaws.com" >> deployment-report.md
          echo "- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: http://dev-taskflow-alb-550446343.us-east-1.elb.amazonaws.com/api" >> deployment-report.md
          echo "- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: http://dev-taskflow-alb-550446343.us-east-1.elb.amazonaws.com/health" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### Wiz Code-to-Cloudãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ç¢ºèªæ‰‹é †" >> deployment-report.md
          echo "1. Wizã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³" >> deployment-report.md
          echo "2. **Inventory** â†’ **Workloads** â†’ **ECS Tasks**" >> deployment-report.md
          echo "3. \`dev-taskflow\` ã§æ¤œç´¢" >> deployment-report.md
          echo "4. å¯¾è±¡ã‚¿ã‚¹ã‚¯ã‚’é¸æŠ" >> deployment-report.md
          echo "5. **Security Graph** ã‚¿ãƒ–ã‚’é–‹ã" >> deployment-report.md
          echo "6. **Code Origin** ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¾ã§ã®è¿½è·¡ã‚’ç¢ºèª" >> deployment-report.md
          echo "   - GitHubãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}" >> deployment-report.md
          echo "   - ã‚³ãƒŸãƒƒãƒˆSHA: ${{ github.sha }}" >> deployment-report.md
          echo "   - ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ" >> deployment-report.md
          echo "- âœ… ECRã‚¤ãƒ¡ãƒ¼ã‚¸ã«Code-to-Cloudãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹" >> deployment-report.md
          echo "- âœ… ECSã‚¿ã‚¹ã‚¯ã‹ã‚‰GitHubãƒªãƒã‚¸ãƒˆãƒªã¾ã§ãƒˆãƒ¬ãƒ¼ã‚¹å¯èƒ½" >> deployment-report.md
          echo "- âœ… è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³çµæœãŒWizã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã§ãã‚‹" >> deployment-report.md
          echo "- âœ… SBOMãŒç”Ÿæˆã•ã‚Œã€ä¾å­˜é–¢ä¿‚ãŒè¿½è·¡ã§ãã‚‹" >> deployment-report.md

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report-${{ github.sha }}
          path: deployment-report.md
