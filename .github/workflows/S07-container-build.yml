# S07: コンテナトレーサビリティ - Code-to-Cloudメタデータ付きコンテナビルド
#
# このワークフローは、Dockerイメージをビルドし、Code-to-Cloudトレーサビリティのための
# メタデータを付与してECRにプッシュし、ECSにデプロイします
# シナリオS07の検証に使用します
#
# 実際のAWS環境設定:
# - リージョン: us-east-1
# - AWSアカウント: 066338625871
# - ECRリポジトリ: dev-taskflow-backend, dev-taskflow-frontend
# - ECSクラスター: dev-taskflow-cluster
# - ECSサービス: dev-taskflow-backend-service, dev-taskflow-frontend-service

name: S07 - Container Build and Traceability

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'taskflow-app/backend/**'
      - 'taskflow-app/frontend/**'
      - 'taskflow-app/docker-compose.yml'
      - '.github/workflows/S07-container-build.yml'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: '066338625871'
  ECR_BACKEND_REPO: dev-taskflow-backend
  ECR_FRONTEND_REPO: dev-taskflow-frontend
  ECS_CLUSTER: dev-taskflow-cluster
  ECS_BACKEND_SERVICE: dev-taskflow-backend-service
  ECS_FRONTEND_SERVICE: dev-taskflow-frontend-service

jobs:
  build-and-scan-backend:
    name: バックエンドコンテナビルド＆スキャン
    runs-on: ubuntu-latest
    steps:
      - name: コードチェックアウト
        uses: actions/checkout@v4

      - name: AWSクレデンシャル設定
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Amazon ECRログイン
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Dockerイメージビルド（メタデータ付き）
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd taskflow-app/backend
          docker build \
            --build-arg GIT_COMMIT=${{ github.sha }} \
            --build-arg GIT_BRANCH=${{ github.ref_name }} \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg BUILD_ID=${{ github.run_id }} \
            --build-arg GITHUB_REPOSITORY=${{ github.repository }} \
            -t $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG \
            -t $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest \
            .

      - name: Wiz CLIイメージ取得
        run: |
          docker pull public-registry.wiz.io/wiz-app/wizcli:1
          docker tag public-registry.wiz.io/wiz-app/wizcli:1 wizcli:latest

      - name: Wiz認証
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            wizcli:latest auth

      - name: Dockerイメージスキャン
        id: docker_scan
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest docker scan \
            --image $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG \
            --policy "Default vulnerabilities policy" \
            --policy-hits-only \
            --tag "component=backend" \
            --tag "environment=dev" \
            --tag "scan-type=pre-push" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --dockerfile /scan/taskflow-app/backend/Dockerfile \
            --output /scan/backend-scan-results.sarif,sarif \
            --output /scan/backend-scan-results.json,json
        continue-on-error: true

      - name: スキャン結果をアーティファクトとして保存
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-scan-results-${{ github.sha }}
          path: |
            backend-scan-results.sarif
            backend-scan-results.json

      - name: Code-to-Cloudメタデータタグ付け
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            wizcli:latest docker tag \
            --image $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG \
            --source-repo "${{ github.repository }}" \
            --source-branch "${{ github.ref_name }}" \
            --source-commit "${{ github.sha }}" \
            --ci-build-id "${{ github.run_id }}"

      - name: ECRにイメージプッシュ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest

      - name: イメージ情報を出力
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "## バックエンドコンテナビルド完了" > build-info-backend.md
          echo "" >> build-info-backend.md
          echo "- リポジトリ: ${{ github.repository }}" >> build-info-backend.md
          echo "- ブランチ: ${{ github.ref_name }}" >> build-info-backend.md
          echo "- コミット: ${{ github.sha }}" >> build-info-backend.md
          echo "- ビルドID: ${{ github.run_id }}" >> build-info-backend.md
          echo "- イメージ: \`$ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:$IMAGE_TAG\`" >> build-info-backend.md
          echo "- イメージ（latest）: \`$ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest\`" >> build-info-backend.md
          echo "" >> build-info-backend.md
          echo "WizコンソールでCode-to-Cloudトレーサビリティを確認できます。" >> build-info-backend.md

      - name: ビルド情報をアーティファクトとして保存
        uses: actions/upload-artifact@v4
        with:
          name: build-info-backend-${{ github.sha }}
          path: build-info-backend.md

  build-and-scan-frontend:
    name: フロントエンドコンテナビルド＆スキャン
    runs-on: ubuntu-latest
    steps:
      - name: コードチェックアウト
        uses: actions/checkout@v4

      - name: AWSクレデンシャル設定
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Amazon ECRログイン
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Dockerイメージビルド（メタデータ付き）
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd taskflow-app/frontend
          docker build \
            --build-arg GIT_COMMIT=${{ github.sha }} \
            --build-arg GIT_BRANCH=${{ github.ref_name }} \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg BUILD_ID=${{ github.run_id }} \
            --build-arg GITHUB_REPOSITORY=${{ github.repository }} \
            -t $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG \
            -t $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest \
            .

      - name: Wiz CLIイメージ取得
        run: |
          docker pull public-registry.wiz.io/wiz-app/wizcli:1
          docker tag public-registry.wiz.io/wiz-app/wizcli:1 wizcli:latest

      - name: Wiz認証
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            wizcli:latest auth

      - name: Dockerイメージスキャン
        id: docker_scan
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest docker scan \
            --image $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG \
            --policy "Default vulnerabilities policy" \
            --policy-hits-only \
            --tag "component=frontend" \
            --tag "environment=dev" \
            --tag "scan-type=pre-push" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --dockerfile /scan/taskflow-app/frontend/Dockerfile \
            --output /scan/frontend-scan-results.sarif,sarif \
            --output /scan/frontend-scan-results.json,json
        continue-on-error: true

      - name: スキャン結果をアーティファクトとして保存
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-scan-results-${{ github.sha }}
          path: |
            frontend-scan-results.sarif
            frontend-scan-results.json

      - name: Code-to-Cloudメタデータタグ付け
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            wizcli:latest docker tag \
            --image $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG \
            --source-repo "${{ github.repository }}" \
            --source-branch "${{ github.ref_name }}" \
            --source-commit "${{ github.sha }}" \
            --ci-build-id "${{ github.run_id }}"

      - name: ECRにイメージプッシュ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest

      - name: イメージ情報を出力
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "## フロントエンドコンテナビルド完了" > build-info-frontend.md
          echo "" >> build-info-frontend.md
          echo "- リポジトリ: ${{ github.repository }}" >> build-info-frontend.md
          echo "- ブランチ: ${{ github.ref_name }}" >> build-info-frontend.md
          echo "- コミット: ${{ github.sha }}" >> build-info-frontend.md
          echo "- ビルドID: ${{ github.run_id }}" >> build-info-frontend.md
          echo "- イメージ: \`$ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:$IMAGE_TAG\`" >> build-info-frontend.md
          echo "- イメージ（latest）: \`$ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest\`" >> build-info-frontend.md
          echo "" >> build-info-frontend.md
          echo "WizコンソールでCode-to-Cloudトレーサビリティを確認できます。" >> build-info-frontend.md

      - name: ビルド情報をアーティファクトとして保存
        uses: actions/upload-artifact@v4
        with:
          name: build-info-frontend-${{ github.sha }}
          path: build-info-frontend.md

  deploy-to-ecs:
    name: ECSへのデプロイ
    runs-on: ubuntu-latest
    needs: [build-and-scan-backend, build-and-scan-frontend]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: コードチェックアウト
        uses: actions/checkout@v4

      - name: AWSクレデンシャル設定
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Amazon ECRログイン
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: バックエンドをECSにデプロイ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "バックエンドのECSサービスを更新します..."

          # 強制的に新しいデプロイを実行（latestタグを使用）
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_BACKEND_SERVICE }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "✅ バックエンドサービスの更新を開始しました"
          echo "イメージ: $ECR_REGISTRY/${{ env.ECR_BACKEND_REPO }}:latest"

      - name: フロントエンドをECSにデプロイ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "フロントエンドのECSサービスを更新します..."

          # 強制的に新しいデプロイを実行（latestタグを使用）
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_FRONTEND_SERVICE }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "✅ フロントエンドサービスの更新を開始しました"
          echo "イメージ: $ECR_REGISTRY/${{ env.ECR_FRONTEND_REPO }}:latest"

      - name: デプロイ完了を待機
        run: |
          echo "デプロイが完了するまで待機しています..."
          echo "これには2-3分かかります..."

          # バックエンドの待機
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_BACKEND_SERVICE }} \
            --region ${{ env.AWS_REGION }} || echo "バックエンドの待機がタイムアウトしました（デプロイは継続中）"

          # フロントエンドの待機
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_FRONTEND_SERVICE }} \
            --region ${{ env.AWS_REGION }} || echo "フロントエンドの待機がタイムアウトしました（デプロイは継続中）"

          echo "✅ デプロイ完了"

      - name: デプロイ後の確認
        run: |
          echo "## デプロイ後の確認"

          # バックエンドサービスの状態
          echo "### バックエンドサービス"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_BACKEND_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].[serviceName,runningCount,desiredCount,deployments[0].status]' \
            --output table

          # フロントエンドサービスの状態
          echo "### フロントエンドサービス"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_FRONTEND_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].[serviceName,runningCount,desiredCount,deployments[0].status]' \
            --output table

      - name: デプロイ完了レポート生成
        run: |
          echo "## S07検証: コンテナデプロイ完了" > deployment-report.md
          echo "" >> deployment-report.md
          echo "### デプロイ情報" >> deployment-report.md
          echo "- ブランチ: ${{ github.ref_name }}" >> deployment-report.md
          echo "- コミット: ${{ github.sha }}" >> deployment-report.md
          echo "- ビルドID: ${{ github.run_id }}" >> deployment-report.md
          echo "- デプロイ日時: $(date)" >> deployment-report.md
          echo "- リージョン: ${{ env.AWS_REGION }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### デプロイ先" >> deployment-report.md
          echo "- ECSクラスター: ${{ env.ECS_CLUSTER }}" >> deployment-report.md
          echo "- バックエンドサービス: ${{ env.ECS_BACKEND_SERVICE }}" >> deployment-report.md
          echo "- フロントエンドサービス: ${{ env.ECS_FRONTEND_SERVICE }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### アクセスURL" >> deployment-report.md
          echo "- ALB DNS: \`dev-taskflow-alb-550446343.us-east-1.elb.amazonaws.com\`" >> deployment-report.md
          echo "- フロントエンド: http://dev-taskflow-alb-550446343.us-east-1.elb.amazonaws.com" >> deployment-report.md
          echo "- バックエンドAPI: http://dev-taskflow-alb-550446343.us-east-1.elb.amazonaws.com/api" >> deployment-report.md
          echo "- ヘルスチェック: http://dev-taskflow-alb-550446343.us-east-1.elb.amazonaws.com/health" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### Wiz Code-to-Cloudトレーサビリティ確認手順" >> deployment-report.md
          echo "1. Wizコンソールにログイン" >> deployment-report.md
          echo "2. **Inventory** → **Workloads** → **ECS Tasks**" >> deployment-report.md
          echo "3. \`dev-taskflow\` で検索" >> deployment-report.md
          echo "4. 対象タスクを選択" >> deployment-report.md
          echo "5. **Security Graph** タブを開く" >> deployment-report.md
          echo "6. **Code Origin** セクションでソースコードまでの追跡を確認" >> deployment-report.md
          echo "   - GitHubリポジトリ: ${{ github.repository }}" >> deployment-report.md
          echo "   - コミットSHA: ${{ github.sha }}" >> deployment-report.md
          echo "   - ブランチ: ${{ github.ref_name }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### 検証ポイント" >> deployment-report.md
          echo "- ✅ ECRイメージにCode-to-Cloudメタデータが付与されている" >> deployment-report.md
          echo "- ✅ ECSタスクからGitHubリポジトリまでトレース可能" >> deployment-report.md
          echo "- ✅ 脆弱性スキャン結果がWizコンソールで確認できる" >> deployment-report.md
          echo "- ✅ SBOMが生成され、依存関係が追跡できる" >> deployment-report.md

      - name: デプロイレポートをアーティファクトとして保存
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report-${{ github.sha }}
          path: deployment-report.md
