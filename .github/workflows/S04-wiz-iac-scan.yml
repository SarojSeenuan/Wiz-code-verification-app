# S04: IaCã‚¹ã‚­ãƒ£ãƒ³ - Terraformè¨­å®šæ¤œè¨¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€Terraformã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ¼ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿæ–½ã—ã¾ã™
# ã‚·ãƒŠãƒªã‚ªS04ã®æ¤œè¨¼ã«ä½¿ç”¨ã—ã¾ã™

name: S04 - Wiz IaC Scan

on:
  push:
    branches:
      - master
      - develop
    paths:
      - "taskflow-app/terraform/**"
  pull_request:
    branches:
      - master
    paths:
      - "taskflow-app/terraform/**"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  terraform-iac-scan:
    name: Terraformã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Terraformã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraformãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        run: |
          terraform fmt -check -recursive taskflow-app/terraform/

      - name: Wiz CLIã‚¤ãƒ¡ãƒ¼ã‚¸å–å¾—
        run: |
          docker pull public-registry.wiz.io/wiz-app/wizcli:1
          docker tag public-registry.wiz.io/wiz-app/wizcli:1 wizcli:latest

      - name: Wizèªè¨¼
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            wizcli:latest auth

      - name: Terraformå…¨ä½“ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest iac scan \
            --path /scan/taskflow-app/terraform \
            --name "terraform-full-${{ github.sha }}" \
            --tag "environment=all" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --tag "scan-type=iac" \
            --policy-hits-only

      - name: Terraform Devç’°å¢ƒã‚¹ã‚­ãƒ£ãƒ³
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest iac scan \
            --path /scan/taskflow-app/terraform/environments/dev \
            --name "terraform-dev-${{ github.sha }}" \
            --tag "environment=dev" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --policy-hits-only

      - name: Terraform Prodç’°å¢ƒã‚¹ã‚­ãƒ£ãƒ³
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest iac scan \
            --path /scan/taskflow-app/terraform/environments/prod \
            --name "terraform-prod-${{ github.sha }}" \
            --tag "environment=prod" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --policy-hits-only

      - name: Terraform Vulnerableç’°å¢ƒã‚¹ã‚­ãƒ£ãƒ³ï¼ˆæ¤œè¨¼ç”¨ï¼‰
        id: vulnerable_scan
        run: |
          docker run --rm \
            -e WIZ_CLIENT_ID="${{ secrets.WIZ_CLIENT_ID }}" \
            -e WIZ_CLIENT_SECRET="${{ secrets.WIZ_CLIENT_SECRET }}" \
            --mount type=bind,src="${PWD}",dst=/scan \
            wizcli:latest iac scan \
            --path /scan/taskflow-app/terraform/environments/vulnerable \
            --name "terraform-vulnerable-${{ github.sha }}" \
            --tag "environment=vulnerable" \
            --tag "branch=${{ github.ref_name }}" \
            --tag "commit=${{ github.sha }}" \
            --tag "purpose=security-testing" \
            --output /scan/vulnerable-iac-results.sarif,sarif \
            --output /scan/vulnerable-iac-results.json,json \
            --policy-hits-only
        continue-on-error: true

      - name: SARIFçµæœã‚’GitHub Securityã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: vulnerable-iac-results.sarif
          category: wiz-iac-vulnerable

      - name: ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’Artifactã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerable-iac-scan-results-${{ github.sha }}
          path: |
            vulnerable-iac-results.sarif
            vulnerable-iac-results.json

      - name: ã‚¹ã‚­ãƒ£ãƒ³çµæœã®ç¢ºèª
        if: steps.vulnerable_scan.outcome == 'failure'
        run: |
          echo "âŒ Vulnerableç’°å¢ƒã®ã‚¹ã‚­ãƒ£ãƒ³ã§ãƒãƒªã‚·ãƒ¼é•åã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
          echo "ğŸ“Š æ¤œå‡ºã‚µãƒãƒªãƒ¼:"
          cat vulnerable-iac-results.json | jq '.summary' || echo "No summary available"
          echo ""
          echo "ğŸ”´ ã“ã‚Œã¯æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã§ã™ï¼ˆæ¤œè¨¼ç”¨ã®è„†å¼±ãªè¨­å®šï¼‰"
          echo "è©³ç´°ã¯GitHub Securityã‚¿ãƒ–ã¨Wizã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„"

  terraform-validation:
    name: Terraformæ¤œè¨¼
    runs-on: ubuntu-latest
    needs: terraform-iac-scan
    strategy:
      matrix:
        environment: [dev, prod]
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Terraformã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: |
          cd taskflow-app/terraform/environments/${{ matrix.environment }}
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd taskflow-app/terraform/environments/${{ matrix.environment }}
          terraform validate

      - name: Terraform Planï¼ˆPRã®å ´åˆã®ã¿ï¼‰
        if: github.event_name == 'pull_request'
        run: |
          cd taskflow-app/terraform/environments/${{ matrix.environment }}
          terraform plan -no-color

  generate-iac-report:
    name: IaCãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [terraform-iac-scan, terraform-validation]
    if: always()
    steps:
      - name: IaCã‚¹ã‚­ãƒ£ãƒ³ã‚µãƒãƒªãƒ¼å‡ºåŠ›
        run: |
          echo "## S04æ¤œè¨¼: Terraform IaCã‚¹ã‚­ãƒ£ãƒ³çµæœ" > iac-scan-summary.md
          echo "" >> iac-scan-summary.md
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}" >> iac-scan-summary.md
          echo "- ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}" >> iac-scan-summary.md
          echo "- ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡: terraform/" >> iac-scan-summary.md
          echo "" >> iac-scan-summary.md
          echo "### ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«" >> iac-scan-summary.md
          echo "- ECS" >> iac-scan-summary.md
          echo "- RDS" >> iac-scan-summary.md
          echo "- ECR" >> iac-scan-summary.md
          echo "- Networking" >> iac-scan-summary.md
          echo "" >> iac-scan-summary.md
          echo "è©³ç´°ã¯Wizã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> iac-scan-summary.md

      - name: ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: iac-scan-summary-${{ github.sha }}
          path: iac-scan-summary.md
